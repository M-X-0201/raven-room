<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ‹‰æ–‡å…‹åŠ³ä¼‘æ¯å®¤</title>

<style>
:root{
  --bg1:#fbfbff;
  --bg2:#f3f5ff;
  --card:rgba(255,255,255,.70);
  --text:#2b2f45;
  --muted:#7a7f9f;
  --iris:#7d8cff;
  --iris2:#a7b2ff;
  --mint:#9de7de;

  --radiusL:36px;
  --radiusM:26px;
  --radiusS:20px;

  --shadow:0 18px 55px rgba(40,50,90,.10);
  --shadow2:0 10px 26px rgba(40,50,90,.08);
  --border:rgba(70,80,130,.12);
  --inner: inset 0 1px 0 rgba(255,255,255,.7);
}

[data-theme="dark"]{
  --bg1:#0f1326;
  --bg2:#11183a;
  --card:rgba(255,255,255,.10);
  --text:#f2f3ff;
  --muted:#a7add6;

  --shadow:0 22px 70px rgba(0,0,0,.45);
  --shadow2:0 14px 36px rgba(0,0,0,.35);
  --border:rgba(255,255,255,.14);
  --inner: inset 0 1px 0 rgba(255,255,255,.12);
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei";
  color:var(--text);
  background:
    radial-gradient(900px 600px at 18% 14%, rgba(125,140,255,.16), transparent 62%),
    radial-gradient(900px 600px at 82% 18%, rgba(157,231,222,.10), transparent 62%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:14px;
  letter-spacing:.3px;
  line-height:1.7;
}

/* æ¡Œé¢ç«¯ï¼šå¼ºåˆ¶ä¸€å±ï¼Œä¸æ»šåŠ¨ã€‚æ‰‹æœºç«¯å…è®¸è‡ªç„¶æ»šåŠ¨ */
@media(min-width:941px){
  body{ overflow:hidden; }
}

.grain{
  position:fixed; inset:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='.10'/%3E%3C/svg%3E");
  mix-blend-mode:overlay;
  opacity:.55;
  pointer-events:none;
}
[data-theme="dark"] .grain{ opacity:.30; }

.shell{
  width:980px;
  max-width:95vw;
  display:grid;
  grid-template-columns: 1.08fr .92fr;
  gap:14px;
}

/* æ¡Œé¢ç«¯å¡ç‰‡é«˜åº¦å‹è¿›ä¸€å± */
@media(min-width:941px){
  .shell{
    height: calc(100vh - 28px);
  }
}

@media(max-width:940px){
  body{ align-items:flex-start; }
  .shell{ grid-template-columns:1fr; height:auto; }
}

.card{
  border:1px solid var(--border);
  border-radius:var(--radiusL);
  background:linear-gradient(180deg, var(--card), rgba(255,255,255,.04));
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  overflow:hidden;
}

.pad{ padding:16px; }

.header{
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-start;
}
.hTitle{
  font-size:18px;
  font-weight:650;
  margin:0;
}
.hSub{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

.iconRow{ display:flex; gap:10px; align-items:center; }
.iconBtn{
  border:1px solid var(--border);
  background:rgba(255,255,255,.10);
  color:var(--text);
  border-radius:999px;
  padding:10px 12px;
  cursor:pointer;
  box-shadow:var(--inner);
  transition:.15s;
  user-select:none;
}
.iconBtn:active{ transform:translateY(2px) scale(.98); }

/* LEFT */
.leftCard{
  display:grid;
  grid-template-rows: auto 1fr auto; /* header / body / bottom */
  height:100%;
}

.leftBody{
  display:grid;
  grid-template-rows: auto auto auto; /* ring / quote / controls */
  align-content:start;
  padding: 6px 0 0;
}

.ringWrap{ display:grid; place-items:center; padding-top:2px; }

.ring{
  width:252px;height:252px; /* smaller to fit */
  position:relative;
  display:grid;
  place-items:center;
}
@media(max-width:400px){
  .ring{ width:220px;height:220px; }
}

.glow{
  position:absolute;
  inset:-14px;
  border-radius:50%;
  background:
    radial-gradient(circle at 32% 30%, rgba(125,140,255,.20), transparent 62%),
    radial-gradient(circle at 72% 62%, rgba(157,231,222,.10), transparent 62%),
    radial-gradient(circle at 40% 84%, rgba(167,178,255,.12), transparent 62%);
  filter:blur(18px);
  animation:breathe 2.9s ease-in-out infinite;
}
@keyframes breathe{
  0%,100%{ transform:scale(.985); opacity:.78; }
  50%{ transform:scale(1.03); opacity:1; }
}

.ring svg{ transform:rotate(-90deg); filter: drop-shadow(0 14px 26px rgba(0,0,0,.10)); }
.time{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:44px;
  font-weight:640;
  letter-spacing:1px;
}

.controls{
  text-align:center;
  margin-top:4px;
}
.btn{
  border:none;
  border-radius:999px;
  padding:9px 14px; /* slightly smaller */
  margin:6px;
  font-weight:650;
  cursor:pointer;
  color:var(--text);
  background:linear-gradient(180deg, rgba(125,140,255,.20), rgba(125,140,255,.08));
  box-shadow:var(--shadow2), var(--inner);
  transition:.15s;
  user-select:none;
}
.btn.secondary{
  background:linear-gradient(180deg, rgba(157,231,222,.14), rgba(157,231,222,.06));
}
.btn:active{ transform:translateY(2px) scale(.98); }

.focusQuote{
  margin:10px 16px 0;
  border-radius:var(--radiusM);
  background:linear-gradient(180deg, rgba(255,253,247,.82), rgba(255,255,255,.22));
  border:1px dashed rgba(125,140,255,.28);
  box-shadow:var(--shadow2);
  padding:10px 12px;
}
[data-theme="dark"] .focusQuote{ background:rgba(255,255,255,.06); }
.fqTop{ display:flex; align-items:center; gap:10px; margin-bottom:6px; }
.fqMark{
  width:30px;height:30px;
  display:grid; place-items:center;
  border-radius:12px;
  border:1px solid rgba(125,140,255,.24);
  background:rgba(125,140,255,.10);
  box-shadow:var(--inner);
  font-size:16px;
}
.fqLabel{ font-size:12px; color:var(--muted); font-weight:650; }
.fqText{ font-size:14px; font-weight:560; }

.settingsRow{
  padding:12px 16px 16px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
.setting{
  display:flex;
  align-items:center;
  gap:8px;
  min-width: 180px;
}
.setting label{
  font-size:12px;
  color:var(--muted);
  font-weight:650;
}
input{
  width:92px;
  border-radius:16px;
  padding:8px 10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.10);
  color:var(--text);
  box-shadow:var(--inner);
  outline:none;
  font-weight:560;
}
.stat{
  display:flex;
  align-items:baseline;
  gap:10px;
}
.stat .k{ font-size:12px; color:var(--muted); font-weight:650; }
.stat .v{ font-weight:650; }

/* RIGHT: two equal cards */
.rightCol{
  display:grid;
  grid-template-rows: 1fr 1fr;
  gap:14px;
  height:100%;
}

/* Iris note */
.notePaper{
  margin-top:10px;
  border-radius:var(--radiusM);
  background:linear-gradient(180deg, rgba(255,253,247,.92), rgba(255,255,255,.40));
  border:1px dashed rgba(125,140,255,.28);
  box-shadow:var(--shadow2);
  padding:14px 14px;
  transform: rotate(-.6deg);
}
[data-theme="dark"] .notePaper{ background:rgba(255,255,255,.06); transform:none; }
.noteMain{
  font-size:15px;
  font-weight:600;
  text-align:center;
  padding:8px 6px;
}
.noteSrc{
  font-size:12px;
  color:var(--muted);
  text-align:right;
  margin-top:6px;
}
.noteActions{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* Mood diary */
.diaryTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-top:4px;
}
.datePill{
  font-size:12px;
  color:var(--muted);
  border:1px solid var(--border);
  background:rgba(255,255,255,.10);
  padding:6px 10px;
  border-radius:999px;
  box-shadow:var(--inner);
}
.stickers{
  margin-top:12px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.sticker{
  border:1px solid var(--border);
  background:rgba(255,255,255,.10);
  border-radius:999px;
  padding:8px 10px;
  cursor:pointer;
  box-shadow:var(--inner);
  transition:.15s;
  user-select:none;
  font-weight:560;
  font-size:13px;
}
.sticker:active{ transform:translateY(2px) scale(.98); }
.sticker.on{
  border-color: rgba(125,140,255,.36);
  background: linear-gradient(180deg, rgba(125,140,255,.18), rgba(125,140,255,.08));
}
.selectedLine{
  margin-top:12px;
  border-top:1px dashed rgba(125,140,255,.22);
  padding-top:10px;
  font-size:12px;
  color:var(--muted);
}
.selectedBadges{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.badge{
  border-radius:999px;
  padding:6px 10px;
  border:1px solid rgba(125,140,255,.22);
  background:rgba(125,140,255,.08);
  font-size:12px;
  color:var(--text);
  box-shadow:var(--inner);
}

/* bubble */
.bubble{
  position:fixed;
  bottom:16px;
  right:16px;
  width:min(360px, 92vw);
  background:linear-gradient(180deg, var(--card), rgba(255,255,255,.04));
  border-radius:22px;
  padding:14px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  display:none;
  z-index:50;
}
.bubble.show{ display:block; }
.bubble .quote{ font-size:14px; font-weight:560; line-height:1.55; color:var(--text); }
.bubble .small{ margin-top:6px; font-size:12px; color:var(--muted); }

/* modal */
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:60;
}
.overlay.show{ display:flex; }
.modal{
  width:min(820px, 96vw);
  background:linear-gradient(180deg, var(--card), rgba(255,255,255,.04));
  border:1px solid var(--border);
  border-radius:28px;
  box-shadow:var(--shadow);
  padding:16px;
  backdrop-filter:blur(14px);
}
.modalTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.modalTop .ttl{ font-weight:650; }
.modalTop .sub{ color:var(--muted); font-size:12px; margin-top:4px; }
.closeX{
  border:1px solid var(--border);
  background:rgba(255,255,255,.10);
  border-radius:999px;
  padding:8px 10px;
  cursor:pointer;
  box-shadow: var(--inner);
  font-weight:650;
  color:var(--text);
}
.reader{
  margin-top:12px;
  border-radius:22px;
  border:1px solid var(--border);
  overflow:hidden;
  background:rgba(255,255,255,.06);
}
.reader iframe{
  width:100%;
  height:min(72vh, 600px);
  border:0;
}
.readerText{
  padding:14px;
  line-height:1.8;
  font-weight:520;
  color:var(--text);
  max-height:min(72vh, 600px);
  overflow:auto;
}
.list{
  margin-top:12px;
  display:grid;
  gap:10px;
}
.item{
  padding:12px;
  border:1px solid var(--border);
  border-radius:18px;
  background:rgba(255,255,255,.08);
  cursor:pointer;
  box-shadow:var(--inner);
}
.item .p{ font-weight:650; }
.item .s{ margin-top:4px; font-size:12px; color:var(--muted); }

/* 1. ä¹¦æ¶å†…å®¹æ»šåŠ¨æ¡ */
.rightCol .card {
  overflow-y: auto;
  max-height: 450px;  /* è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œè¶…å‡ºéƒ¨åˆ†å¯æ»šåŠ¨ */
  padding: 10px;  /* åŠ ç‚¹å†…è¾¹è·ï¼Œé¿å…å†…å®¹ç´§è´´è¾¹ç¼˜ */
}

/* 2. æ‰‹æœºç«¯é€‚é…ï¼šä¹¦æ¶æ˜¾ç¤ºæ–¹å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .shell {
    max-width: 100%; /* è‡ªé€‚åº”å±å¹•å®½åº¦ */
    gap: 10px;       /* æ›´ç´§å‡‘çš„å¸ƒå±€ */
    flex-direction: column; /* è®©å·¦å³å¸ƒå±€å˜æˆä¸Šä¸‹å¸ƒå±€ */
  }

  .rightCol {
    display: block;
    padding: 0 10px;
  }

  .rightCol .card {
    margin-bottom: 10px;  /* æ¯ä¸ªå¡ç‰‡ä¹‹é—´æœ‰é—´éš” */
  }

  .notePaper {
    font-size: 14px; /* å­—ä½“å¤§å°é€‚åº”æ‰‹æœºå±å¹• */
    padding: 10px;
  }
}

/* 3. è‡ªåŠ¨è·Ÿéšç³»ç»Ÿäº®/æš—æ¨¡å¼ */
@media (prefers-color-scheme: dark) {
  /* å¤œé—´æ¨¡å¼ */
  :root {
    --bg1: #121212;  /* æ·±è‰²èƒŒæ™¯ */
    --bg2: #1e1e1e;  /* æ›´æš—èƒŒæ™¯ */
    --card: rgba(255, 255, 255, 0.10);  /* å¡ç‰‡èƒŒæ™¯ */
    --text: #f2f3ff;  /* æ–‡å­—é¢œè‰² */
    --muted: #9aa0c6;
  }

  .bubble {
    background: linear-gradient(180deg, var(--card), rgba(255,255,255,.04));
  }

  .notePaper {
    background: rgba(255,255,255,.06);
  }

  .focusQuote {
    background: linear-gradient(180deg, rgba(255,253,247,.82), rgba(255,255,255,.22));
    border: 1px dashed rgba(125,140,255,.28);
  }
}

@media (prefers-color-scheme: light) {
  /* ç™½å¤©æ¨¡å¼ */
  :root {
    --bg1: #fbfbff;  /* æµ…è‰²èƒŒæ™¯ */
    --bg2: #f3f5ff;  /* æ›´æµ…èƒŒæ™¯ */
    --card: rgba(255, 255, 255, .70);  /* å¡ç‰‡èƒŒæ™¯ */
    --text: #2b2f45;  /* æ–‡å­—é¢œè‰² */
    --muted: #7a7f9f;
  }

  .bubble {
    background: linear-gradient(180deg, var(--card), rgba(255,255,255,.04));
  }

  .notePaper {
    background: linear-gradient(180deg, rgba(255,253,247,.92), rgba(255,255,255,.40));
  }

  .focusQuote {
    background: linear-gradient(180deg, rgba(255,253,247,.82), rgba(255,255,255,.22));
    border: 1px dashed rgba(125,140,255,.28);
  }
}
</style>
</head>

<body>
<div class="grain"></div>

<div class="shell">

  <!-- LEFT -->
  <div class="card leftCard">
    <div class="pad">
      <div class="header">
        <div>
          <h1 class="hTitle">æ‹‰æ–‡å…‹åŠ³ä¼‘æ¯å®¤</h1>
          <div class="hSub">å±äºä½ çš„å°ä¸–ç•Œ</div>
        </div>
        <div class="iconRow">
          <button class="iconBtn" id="themeBtn" title="æ·±è‰²æ¨¡å¼">ğŸŒ“</button>
          <button class="iconBtn" id="shelfBtn" title="ä¹¦æ¶">ğŸ“š</button>
        </div>
      </div>
    </div>

    <div class="leftBody">
      <div class="ringWrap">
        <div class="ring">
          <div class="glow"></div>
          <svg viewBox="0 0 100 100">
            <defs>
              <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="var(--iris)"/>
                <stop offset="100%" stop-color="var(--mint)"/>
              </linearGradient>
            </defs>
            <circle cx="50" cy="50" r="42" stroke="rgba(0,0,0,.10)" stroke-width="10" fill="none"/>
            <circle id="progress" cx="50" cy="50" r="42"
              stroke="url(#grad)" stroke-width="10" fill="none"
              stroke-linecap="round"
              stroke-dasharray="263.89"
              stroke-dashoffset="0"/>
          </svg>
          <div class="time" id="timeText">25:00</div>
        </div>

        <div class="controls">
          <button class="btn" id="toggleBtn">å¼€å§‹</button>
          <button class="btn secondary" id="oneLineBtn">ä¸€å¥è¯</button>
        </div>

        <div class="focusQuote">
          <div class="fqTop">
            <div class="fqMark">ğŸ¦‹</div>
            <div class="fqLabel">ä¸“æ³¨è¯­</div>
          </div>
          <div class="fqText" id="focusQuoteText">å‡†å¤‡å¥½äº†å°±å¼€å§‹å§ã€‚ä½ åªéœ€è¦å…ˆèµ°ä¸€æ­¥ã€‚</div>
        </div>
      </div>
    </div>

    <div class="settingsRow">
      <div class="setting">
        <label>ä¸“æ³¨</label>
        <input id="focusMin" type="number" value="25" min="1" />
        <span class="hSub">åˆ†é’Ÿ</span>
      </div>

      <div class="setting">
        <label>ä¼‘æ¯</label>
        <input id="breakMin" type="number" value="5" min="1" />
        <span class="hSub">åˆ†é’Ÿ</span>
      </div>

      <div class="stat">
        <span class="k">ç•ªèŒ„</span>
        <span class="v" id="count">0</span>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="rightCol">

    <!-- Iris note -->
    <div class="card">
      <div class="pad">
        <div class="header">
          <div>
            <h1 class="hTitle">ä»Šæ—¥é¸¢å°¾ä¾¿ç­¾</h1>
            <div class="hSub" id="noteMeta">â€”</div>
          </div>
          <div class="iconRow">
            <button class="iconBtn" id="openInboxBtn" title="ä¿¡ç®±">âœ‰ï¸</button>
          </div>
        </div>

        <div class="notePaper">
          <div class="noteMain" id="noteMain">â€œå…ˆæŠŠè‡ªå·±ç…§é¡¾å¥½ï¼Œä¸–ç•Œæ‰æœ‰æ„ä¹‰ã€‚â€</div>
          <div class="noteSrc" id="noteSrc">â€”â€”ï¼ˆå‡ºå¤„å ä½ï¼‰</div>
        </div>

        <div class="noteActions">
          <button class="btn secondary" id="saveNoteBtn">æ”¶ä¸‹</button>
        </div>
      </div>
    </div>

    <!-- Mood diary -->
    <div class="card">
      <div class="pad">
        <div class="header">
          <div>
            <h1 class="hTitle">ä»Šæ—¥å¿ƒæƒ…</h1>
            <div class="hSub">åƒè´´çº¸ä¸€æ ·è®°å½•</div>
          </div>
          <div class="iconRow">
            <div class="datePill" id="todayPill">â€”</div>
            <button class="iconBtn" id="moodCalendarBtn" title="å¿ƒæƒ…æ—¥å†">ğŸ“…</button>
          </div>
        </div>

        <div class="stickers" id="stickers"></div>

        <div class="selectedLine">å·²é€‰ï¼š</div>
        <div class="selectedBadges" id="selectedBadges"></div>

        <div class="hSub" style="margin-top:10px;">ä½ å¯ä»¥éšæ—¶ä¿®æ”¹åˆ°èˆ’æœä¸ºæ­¢ã€‚</div>
      </div>
    </div>

  </div>
</div>

<!-- Bubble -->
<div class="bubble" id="bubble">
  <div class="quote" id="bubbleText"></div>
  <div class="small" id="bubbleSmall"></div>
</div>

<!-- Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div class="ttl" id="modalTitle">â€”</div>
        <div class="sub" id="modalSub">â€”</div>
      </div>
      <button class="closeX" id="closeX">âœ•</button>
    </div>

    <div class="reader" id="readerFrameWrap" style="display:none;">
      <iframe id="readerFrame" src=""></iframe>
    </div>

    <div class="readerText" id="readerText" style="display:none;"></div>

    <div class="list" id="modalList" style="display:none;"></div>
  </div>
</div>

<script>
/* helpers */
const root = document.documentElement;
function todayStr(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function showBubble(text, small=""){
  const b = document.getElementById("bubble");
  document.getElementById("bubbleText").textContent = text;
  document.getElementById("bubbleSmall").textContent = small;
  b.classList.add("show");
  clearTimeout(showBubble._t);
  showBubble._t = setTimeout(()=>b.classList.remove("show"), 4200);
}

/* theme */
const savedTheme = localStorage.getItem("raven_theme_v21");
if(savedTheme) root.setAttribute("data-theme", savedTheme);
document.getElementById("themeBtn").onclick = () => {
  const cur = root.getAttribute("data-theme");
  const next = (cur === "dark") ? "" : "dark";
  if(next) root.setAttribute("data-theme", next);
  else root.removeAttribute("data-theme");
  localStorage.setItem("raven_theme_v21", next);
  showBubble(next ? "æ·±è‰²æ¨¡å¼å·²å¼€å¯ã€‚" : "æµ…è‰²æ¨¡å¼å›æ¥å•¦ã€‚");
};

/* focus quotes */
const focusPools = [
  { id:"cathy", tag:"", lines:["æŠŠä»Šå¤©æ‹†æˆä¸€å°æ®µä¸€å°æ®µã€‚","ä½ ä¸éœ€è¦å®Œç¾ï¼Œä½ åªéœ€è¦ç»§ç»­ã€‚","å…ˆæŠŠè¿™ä¸€åˆ†é’Ÿç¨³ä½ã€‚"]},
  { id:"blaise", tag:"Blaise", lines:["å¼€å§‹ã€‚ä¸è¦ç­‰çŠ¶æ€ã€‚","åªåšä¸‹ä¸€æ­¥ã€‚","ä¸“æ³¨ã€‚å…¶ä½™éƒ½å…ˆæ”¾ä¸‹ã€‚"]},
  { id:"sarah", tag:"Sarah", lines:["æ…¢ä¸€ç‚¹ä¹Ÿæ²¡å…³ç³»ã€‚","å…ˆå‘¼å¸ï¼Œå†åŠ¨ç¬”ã€‚","ä½ ä¼šåœ¨å®Œæˆé‡Œæ‰¾åˆ°å®‰é™ã€‚"]},
  { id:"noah", tag:"Noah", lines:["äº”åˆ†é’Ÿå°±è¡Œã€‚","åˆ«è·Ÿè„‘å­åµï¼Œå…ˆåŠ¨èµ·æ¥ã€‚","å…ˆåšä¸€å°å—ï¼Œèµ¢å›æ¥ã€‚"]},
];
function pickFocusQuote(){
  const p = focusPools[Math.floor(Math.random()*focusPools.length)];
  const t = p.lines[Math.floor(Math.random()*p.lines.length)];
  return p.tag ? `ã€Œ${t}ã€ Â· ${p.tag}` : `ã€Œ${t}ã€`;
}
const focusQuoteText = document.getElementById("focusQuoteText");

/* pomodoro */
let running=false;
let leftSec=25*60, totalSec=25*60;
let timer=null;
let tomatoes=parseInt(localStorage.getItem("raven_tomatoes_v21")||"0",10);

const timeText=document.getElementById("timeText");
const progress=document.getElementById("progress");
const countEl=document.getElementById("count");
const focusMinEl=document.getElementById("focusMin");
const breakMinEl=document.getElementById("breakMin");

countEl.textContent=tomatoes;
const CIRC=2*Math.PI*42;

function fmt(s){
  const m=String(Math.floor(s/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return `${m}:${ss}`;
}
function renderTimer(){
  timeText.textContent=fmt(leftSec);
  const ratio=leftSec/totalSec;
  progress.style.strokeDasharray=`${CIRC.toFixed(2)}`;
  progress.style.strokeDashoffset=`${(CIRC*(1-ratio)).toFixed(2)}`;
  countEl.textContent=String(tomatoes);
}
function resetTimer(){
  const f=Math.max(1, parseInt(focusMinEl.value||"25",10));
  totalSec=f*60;
  leftSec=totalSec;
  renderTimer();
}
resetTimer();

function refreshFocusQuote(){
  focusQuoteText.textContent = pickFocusQuote();
}

document.getElementById("toggleBtn").onclick=()=>{ 
  running=!running;
  document.getElementById("toggleBtn").textContent=running?"æš‚åœ":"å¼€å§‹";

  if(running){
    refreshFocusQuote();
    showBubble("å¼€å§‹å§ã€‚","ä¸“æ³¨è¯­å·²å°±ä½ã€‚");
    timer=setInterval(()=>{
      leftSec=Math.max(0,leftSec-1);
      renderTimer();
      if(leftSec===0){
        running=false;
        clearInterval(timer);
        document.getElementById("toggleBtn").textContent="å¼€å§‹";
        tomatoes+=1;
        localStorage.setItem("raven_tomatoes_v21", String(tomatoes));
        showBubble("ğŸ… å®Œæˆä¸€æ®µã€‚","ä¸‹ä¸€æ¬¡å¼€å§‹ä¼šåˆ·æ–°æ–°çš„ä¸“æ³¨è¯­ã€‚");
        resetTimer();
      }
    },1000);
  }else{
    clearInterval(timer);
  }
};
document.getElementById("oneLineBtn").onclick=()=> showBubble(pickFocusQuote());

/* Iris note: unsigned main + source (placeholder for now) */
const IRIS_NOTES = [
  { text:"æŠŠè‡ªå·±ç…§é¡¾å¥½ï¼Œæ˜¯ä¸€ç§åŠ›é‡ã€‚", src:"ï¼ˆå‡ºå¤„ï¼šå¾…è¡¥ï¼‰" },
  { text:"æˆ‘å…è®¸è‡ªå·±æ…¢ä¸€ç‚¹ï¼Œä½†ä¸åé€€ã€‚", src:"ï¼ˆå‡ºå¤„ï¼šå¾…è¡¥ï¼‰" },
];
const NOTE_KEYS = { today:"raven_iris_note_today_v21", date:"raven_iris_note_date_v21", inbox:"raven_iris_note_inbox_v21" };

function buildTodayNote(){
  const date=todayStr();
  const cached=localStorage.getItem(NOTE_KEYS.today);
  const cachedDate=localStorage.getItem(NOTE_KEYS.date);
  if(cached && cachedDate===date) return JSON.parse(cached);
  const pick=IRIS_NOTES[Math.floor(Math.random()*IRIS_NOTES.length)];
  const note={ date, text:pick.text, src:pick.src, saved:false };
  localStorage.setItem(NOTE_KEYS.today, JSON.stringify(note));
  localStorage.setItem(NOTE_KEYS.date, date);
  return note;
}
function loadNoteInbox(){
  try{ return JSON.parse(localStorage.getItem(NOTE_KEYS.inbox) || "[]"); }catch{ return []; }
}
function saveNoteToInbox(note){
  const inbox = loadNoteInbox();
  if(!inbox.some(x=>x.date===note.date)) inbox.unshift(note);
  localStorage.setItem(NOTE_KEYS.inbox, JSON.stringify(inbox));
  return inbox;
}
let todayNote=buildTodayNote();
const noteMain=document.getElementById("noteMain");
const noteSrc=document.getElementById("noteSrc");
const noteMeta=document.getElementById("noteMeta");

function renderNote(){
  noteMain.textContent=`â€œ${todayNote.text}â€`;
  noteSrc.textContent=`â€”â€” ${todayNote.src}`;
  noteMeta.textContent = `${todayNote.saved ? "å·²æ”¶ä¸‹" : "æœªæ”¶ä¸‹"} Â· ${todayNote.date}`;
}
renderNote();

document.getElementById("saveNoteBtn").onclick=()=>{
  todayNote.saved=true;
  localStorage.setItem(NOTE_KEYS.today, JSON.stringify(todayNote));
  saveNoteToInbox(todayNote);
  renderNote();
  showBubble("å·²æ”¶è¿›ä¿¡ç®±ã€‚");
};

/* modal system */
const overlay=document.getElementById("overlay");
const closeX=document.getElementById("closeX");
const modalTitle=document.getElementById("modalTitle");
const modalSub=document.getElementById("modalSub");
const readerFrameWrap=document.getElementById("readerFrameWrap");
const readerFrame=document.getElementById("readerFrame");
const readerText=document.getElementById("readerText");
const modalList=document.getElementById("modalList");

function openModal(){ overlay.classList.add("show"); }
function closeModal(){
  overlay.classList.remove("show");
  readerFrameWrap.style.display="none";
  readerText.style.display="none";
  modalList.style.display="none";
  readerFrame.src="";
  readerText.textContent="";
  modalList.innerHTML="";
}
closeX.onclick=closeModal;
overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeModal(); });

function openReader({title, sub, file, text}){
  modalTitle.textContent=title;
  modalSub.textContent=sub||"";
  openModal();
  if(file){
    readerFrameWrap.style.display="block";
    readerFrame.src=file;
  }else{
    readerText.style.display="block";
    readerText.textContent=text||"";
  }
}
function openList({title, sub, items, onClick}){
  modalTitle.textContent=title;
  modalSub.textContent=sub||"";
  openModal();
  modalList.style.display="block";
  modalList.innerHTML="";
  items.forEach((it, idx)=>{
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`<div class="p">${it.primary}</div><div class="s">${it.secondary||""}</div>`;
    row.onclick=()=>onClick(it, idx);
    modalList.appendChild(row);
  });
}

/* inbox */
function openNoteInbox(){
  const inbox=loadNoteInbox();
  if(inbox.length===0){
    openList({
      title:"ä¿¡ç®±",
      sub:"è¿™é‡Œä¼šä¿å­˜ä½ æ”¶ä¸‹çš„æ¯ä¸€å¼ é¸¢å°¾ä¾¿ç­¾ã€‚",
      items:[{ primary:"è¿˜æ²¡æœ‰æ”¶è—", secondary:"ç‚¹ã€Œæ”¶ä¸‹ã€å°±ä¼šå­˜è¿›æ¥ã€‚" }],
      onClick:()=>{}
    });
    return;
  }
  openList({
    title:"ä¿¡ç®±",
    sub:"æŒ‰æ—¥æœŸå›çœ‹",
    items: inbox.map(n=>({
      primary:`${n.date} Â· é¸¢å°¾ä¾¿ç­¾`,
      secondary:`â€œ${n.text}â€  â€”â€” ${n.src}`
    })),
    onClick:(it, idx)=>{
      const n=inbox[idx];
      openReader({ title:`é¸¢å°¾ä¾¿ç­¾ Â· ${n.date}`, sub:n.src, text:`â€œ${n.text}â€\n\nâ€”â€” ${n.src}` });
    }
  });
}
document.getElementById("openInboxBtn").onclick=openNoteInbox;
