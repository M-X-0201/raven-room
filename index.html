<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ‹‰æ–‡å…‹åŠ³ä¼‘æ¯å®¤ | Cathy's Iris Garden</title>

<style>
:root {
  --iris-blue: #5D76CB;
  --iris-purple: #9A9AE0;
  --iris-soft: #E6E6FA;
  --bg-light: #FBFBFE;
  --text-main: #3D3D63;
  --text-sub: #7D7DA3;
  --card-shadow: 0 15px 45px rgba(93, 118, 203, 0.12);
  --radius-l: 36px;
  --radius-m: 22px;
  --iris-medium: #7A7AD0;
  --border-line: rgba(93, 118, 203, 0.15);
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-light: #0A0A15;
    --iris-soft: #1A1A2E;
    --text-main: #E0E0FF;
    --text-sub: #9A9ABF;
    --card-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
    --iris-medium: #9A9AE0;
    --border-line: rgba(255, 255, 255, 0.08);
  }
}

* { box-sizing: border-box; outline: none; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg-light);
  /* ä½¿ç”¨é¸¢å°¾èŠ±çº¹åº•å›¾ï¼Œè‹¥å›¾ç‰‡è·¯å¾„æ­£ç¡®å¯æ›¿æ¢ */
  background-image: radial-gradient(circle at 20% 20%, rgba(154, 154, 224, 0.05), transparent),
                    linear-gradient(135deg, var(--bg-light) 0%, #F1F1FF 100%);
  color: var(--text-main);
  min-height: 100vh;
  display: flex; justify-content: center; align-items: center;
  padding: 20px;
}

@media (prefers-color-scheme: dark) {
  body { background-image: radial-gradient(circle at 20% 20%, rgba(154, 154, 224, 0.08), transparent), linear-gradient(135deg, var(--bg-light) 0%, #12122A 100%); }
}

.shell {
  width: 1080px; max-width: 100%;
  display: grid; grid-template-columns: 1fr 400px; gap: 24px;
}
@media (max-width: 950px) { .shell { grid-template-columns: 1fr; } }

.card {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(25px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: var(--radius-l);
  padding: 30px;
  box-shadow: var(--card-shadow);
  display: flex; flex-direction: column;
}
[data-theme="dark"] .card, @media (prefers-color-scheme: dark) {
  .card { background: rgba(25, 25, 45, 0.85); border: 1px solid rgba(255,255,255,0.05); }
}

/* è®¡æ—¶å™¨åœ†ç¯ä¸å‘¼å¸åŠ¨ç”» */
.timer-box { text-align: center; padding: 20px 0; }
.ring-container {
  width: 260px; height: 260px; margin: 0 auto; position: relative;
}
.ring-container svg { transform: rotate(-90deg); width: 100%; height: 100%; }
.time-text {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  font-size: 64px; font-weight: 400; letter-spacing: 4px;
  font-family: 'Cormorant Garamond', serif;
  text-shadow: 0 2px 10px rgba(93, 118, 203, 0.3);
}
.breathing { animation: iris-breath 3s ease-in-out infinite; }
@keyframes iris-breath {
  0%, 100% { filter: drop-shadow(0 0 5px var(--iris-purple)); opacity: 0.8; }
  50% { filter: drop-shadow(0 0 20px var(--iris-blue)); opacity: 1; }
}

/* æœå†»æŒ‰é’® */
.btn-jelly {
  background: var(--iris-blue); color: white; border: none;
  padding: 14px 40px; border-radius: 20px; font-size: 16px;
  cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 0 8px 15px rgba(93, 118, 203, 0.3);
}
.btn-jelly:active { transform: scale(0.92); box-shadow: 0 4px 8px rgba(93, 118, 203, 0.2); }

/* è¾“å…¥æ¡†è”åŠ¨æ ·å¼ */
.setting-input {
  width: 60px; border: none; background: var(--iris-soft);
  padding: 8px; border-radius: 12px; text-align: center;
  color: var(--text-main); font-weight: 700;
}

/* é¸¢å°¾ä¾¿ç­¾å¡ç‰‡ */
.note-area {
  background: linear-gradient(145deg, var(--iris-soft), #FFF);
  padding: 25px; border-radius: var(--radius-m);
  border: 1px dashed var(--iris-purple); min-height: 180px;
  display: flex; flex-direction: column; justify-content: center;
}
[data-theme="dark"] .note-area, @media (prefers-color-scheme: dark) {
  .note-area { background: var(--iris-soft); }
}

/* æ—¥å†ç½‘æ ¼ */
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
.cal-cell {
  aspect-ratio: 1; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  font-size: 12px; cursor: pointer; background: rgba(154, 154, 224, 0.05);
  transition: all 0.2s;
}
.cal-cell:hover { background: var(--iris-soft); transform: scale(1.05); }
.cal-cell.today { border: 2px solid var(--iris-blue); background: white; }
@media (prefers-color-scheme: dark) {
  .cal-cell.today { background: var(--iris-soft); }
}
.cal-cell .mood-icons {
  font-size: 10px; margin-top: 2px;
}

/* å¼¹çª—ç³»ç»Ÿ */
.overlay {
  position: fixed; inset: 0; background: rgba(13, 13, 26, 0.7);
  display: none; align-items: center; justify-content: center; z-index: 1000;
  backdrop-filter: blur(12px);
}
.modal {
  background: var(--bg-light); width: 95%; max-width: 800px; height: 85vh;
  border-radius: var(--radius-l); overflow: hidden; display: flex; flex-direction: column;
}
.modal-header { padding: 20px 30px; border-bottom: 1px solid var(--border-line); display: flex; justify-content: space-between; align-items: center; }
.modal-body { flex: 1; overflow-y: auto; padding: 0; }
iframe { width: 100%; height: 100%; border: none; }

.item-row { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
.item-row:hover { background: var(--iris-soft); }

/* Toast æç¤º */
.toast {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
  background: var(--iris-blue); color: white; padding: 16px 32px; 
  border-radius: 20px; font-size: 15px; z-index: 2000;
  opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 0 10px 30px rgba(93, 118, 203, 0.4);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ä»Šæ—¥å¿ƒæƒ…è®¡æ•° */
.today-mood-count {
  font-size: 13px; color: var(--text-sub); margin-top: 10px;
}
.today-mood-count span { color: var(--iris-blue); font-weight: bold; }

/* å¿ƒæƒ…å†å²è®°å½• */
.mood-history-item {
  display: flex; align-items: center; gap: 10px; 
  padding: 8px 12px; background: var(--iris-soft); 
  border-radius: 10px; margin-top: 8px; font-size: 13px;
}
.mood-history-item .time { color: var(--text-sub); font-size: 11px; }

/* éŸ³ä¹ç®¡ç†å™¨ */
#music-manager {
  position: fixed;
  bottom: 30px;
  left: 30px;
  z-index: 100;
}
.music-toggle-btn {
  background: rgba(255, 255, 255, 0.8);
  border: 1px solid var(--iris-soft);
  color: var(--iris-blue);
  padding: 12px 20px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 5px 15px rgba(93, 118, 203, 0.15);
}
.music-toggle-btn:hover {
  background: var(--iris-soft);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(93, 118, 203, 0.25);
}
.music-toggle-btn.playing {
  background: var(--iris-blue);
  color: white;
}
.music-panel {
  position: absolute;
  bottom: 55px;
  left: 0;
  width: 320px;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid var(--iris-soft);
  border-radius: var(--radius-m);
  padding: 20px;
  display: none;
  box-shadow: 0 15px 40px rgba(93, 118, 203, 0.2);
  backdrop-filter: blur(15px);
}
.music-panel.active {
  display: block;
  animation: slideUp 0.3s ease;
}
@media (prefers-color-scheme: dark) {
  .music-panel { background: rgba(25, 25, 45, 0.95); }
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.music-panel-title {
  font-size: 16px;
  color: var(--iris-blue);
  margin-bottom: 15px;
  text-align: center;
  border-bottom: 1px solid var(--border-line);
  padding-bottom: 12px;
}
.music-upload-area {
  border: 2px dashed var(--iris-soft);
  border-radius: 15px;
  padding: 20px;
  text-align: center;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.music-upload-area:hover {
  border-color: var(--iris-blue);
  background: var(--iris-soft);
}
.music-upload-area input { display: none; }
.music-upload-icon { font-size: 28px; margin-bottom: 8px; }
.music-upload-text { color: var(--text-sub); font-size: 13px; }
.music-list {
  max-height: 180px;
  overflow-y: auto;
  margin-bottom: 15px;
}
.music-list::-webkit-scrollbar { width: 5px; }
.music-list::-webkit-scrollbar-track { background: var(--iris-soft); border-radius: 3px; }
.music-list::-webkit-scrollbar-thumb { background: var(--iris-purple); border-radius: 3px; }
.music-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  margin-bottom: 8px;
  background: var(--iris-soft);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}
.music-item:hover {
  transform: translateX(5px);
  background: rgba(93, 118, 203, 0.1);
}
.music-item.active {
  background: rgba(93, 118, 203, 0.15);
  border: 1px solid var(--iris-blue);
}
.music-item-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  overflow: hidden;
}
.music-item-icon { font-size: 16px; }
.music-item-name {
  color: var(--text-main);
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.music-item-delete {
  background: transparent;
  border: none;
  color: rgba(200, 100, 100, 0.6);
  cursor: pointer;
  font-size: 14px;
  padding: 5px;
  transition: all 0.2s ease;
}
.music-item-delete:hover {
  color: #c86464;
  transform: scale(1.2);
}
.music-controls {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding-top: 15px;
  border-top: 1px solid var(--border-line);
}
.music-control-btn {
  background: var(--iris-soft);
  border: 1px solid var(--iris-soft);
  color: var(--iris-blue);
  padding: 10px 20px;
  border-radius: 15px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s ease;
}
.music-control-btn:hover {
  background: var(--iris-blue);
  color: white;
}
.music-control-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.music-control-btn.playing {
  background: var(--iris-blue);
  color: white;
}
.no-music {
  text-align: center;
  color: var(--text-sub);
  font-size: 13px;
  padding: 20px;
}
.volume-slider-container {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 0;
  border-top: 1px solid var(--border-line);
  margin-top: 10px;
}
.volume-icon {
  font-size: 16px;
  color: var(--iris-blue);
}
.volume-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  background: var(--iris-soft);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}
.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  background: var(--iris-blue);
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.2s;
}
.volume-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
}
.volume-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  background: var(--iris-blue);
  border-radius: 50%;
  cursor: pointer;
  border: none;
}
.volume-value {
  font-size: 12px;
  color: var(--text-sub);
  min-width: 35px;
  text-align: right;
}

/* å“åº”å¼é€‚é… */
@media (max-width: 950px) {
  .shell { grid-template-columns: 1fr; }
}

@media (max-width: 600px) {
  body {
    padding: 10px;
    align-items: flex-start;
  }
  .shell {
    gap: 16px;
  }
  .card {
    padding: 20px;
  }
  .ring-container {
    width: 200px; height: 200px;
  }
  .time-text {
    font-size: 48px;
    letter-spacing: 2px;
  }
  .modal {
    height: 90vh;
    width: 98%;
    border-radius: 24px;
  }
  .modal-header {
    padding: 15px 20px;
  }
  .cal-grid {
    gap: 4px;
  }
  .cal-cell {
    font-size: 10px;
    border-radius: 8px;
  }
  .cal-cell .mood-icons {
    font-size: 8px;
  }
}
</style>
</head>

<body>
<div class="shell">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="color:var(--iris-blue); margin:0;">æ‹‰æ–‡å…‹åŠ³ä¼‘æ¯å®¤</h2>
      <button class="btn-jelly" onclick="openShelf()" style="padding:8px 20px; border-radius:12px;">ğŸ“š ä¹¦æ¶ç›®å½•</button>
    </div>

    <div class="timer-box">
      <div class="ring-container" id="timerRing">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" stroke="var(--iris-soft)" stroke-width="4" fill="none" />
          <circle id="progress" cx="50" cy="50" r="45" stroke="var(--iris-blue)" stroke-width="4" fill="none" stroke-dasharray="283" stroke-dashoffset="0" stroke-linecap="round" />
        </svg>
        <div class="time-text" id="timeLabel">25:00</div>
      </div>
      <div style="margin-top:30px;">
        <button class="btn-jelly" id="toggleBtn">å¼€å§‹ä¸“æ³¨</button>
      </div>
    </div>

    <div id="focusQuote" style="text-align:center; padding:15px; background:var(--iris-soft); border-radius:20px; font-size:14px; min-height:50px;">
      å‡†å¤‡å¥½äº†å°±å¼€å§‹å§ã€‚
    </div>

    <div style="display:flex; justify-content:center; gap:25px; margin-top:40px; border-top:1px solid rgba(0,0,0,0.05); padding-top:25px;">
      <div>ä¸“æ³¨ <input type="number" id="fMin" value="25" class="setting-input"></div>
      <div>ä¼‘æ¯ <input type="number" id="bMin" value="5" class="setting-input"></div>
      <div style="font-size:14px; color:var(--text-sub);">ğŸ… <span id="tCount" style="color:var(--iris-blue); font-weight:bold;">0</span></div>
    </div>
  </div>

  <div style="display:flex; flex-direction:column; gap:24px;">
    <div class="card">
      <h3 style="margin:0 0 15px 0; font-size:16px; color:var(--iris-medium);">ä»Šæ—¥é¸¢å°¾ä¾¿ç­¾</h3>
      <div class="note-area">
        <div id="noteTxt" style="font-size:16px; font-style:italic;">è½½å…¥ä¸­...</div>
        <div id="noteAuth" style="font-size:12px; color:var(--text-sub); text-align:right; margin-top:15px;">â€”â€”</div>
      </div>
    </div>

    <div class="card" style="flex:1;">
      <h3 style="margin:0; font-size:16px; color:var(--iris-medium);">ä»Šæ—¥å¿ƒæƒ…è´´çº¸</h3>
      <div id="moodList" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:20px;"></div>
      <div id="todayMoodHistory" style="margin-top:15px;"></div>
      <div class="today-mood-count" id="moodCountDisplay"></div>
      <div style="margin-top:auto; padding-top:20px;">
        <button class="btn-jelly" style="background:none; border:1px solid var(--iris-soft); color:var(--text-sub); width:100%;" onclick="openCalendar()">ğŸ“… æŸ¥çœ‹å¿ƒæƒ…æ—¥å†</button>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <span id="backBtn" style="cursor:pointer; color:var(--iris-blue); visibility:hidden;" onclick="renderRoot()">â† è¿”å›ç›®å½•</span>
      <span id="modalTitle" style="font-weight:700;">ä¹¦æ¶</span>
      <span style="cursor:pointer; font-size:24px;" onclick="closeModal()">âœ•</span>
    </div>
    <div class="modal-body" id="modalContent"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="music-manager">
  <button class="music-toggle-btn" id="musicToggleBtn" onclick="toggleMusicPanel()">
    <span>ğŸµ</span>
    <span>éŸ³ä¹</span>
  </button>
  <div class="music-panel" id="music-panel">
    <div class="music-panel-title">ğŸµ éŸ³ä¹ç®¡ç†</div>
    
    <div class="music-upload-area" onclick="document.getElementById('music-file-input').click()">
      <input type="file" id="music-file-input" accept="audio/*" onchange="handleMusicUpload(event)" multiple>
      <div class="music-upload-icon">ğŸ“</div>
      <div class="music-upload-text">ç‚¹å‡»ä¸Šä¼ éŸ³ä¹æ–‡ä»¶<br>(MP3, WAV, OGG ç­‰)</div>
    </div>
    
    <div class="music-list" id="music-list">
      <div class="no-music">æš‚æ— éŸ³ä¹</div>
    </div>
    
    <div class="music-controls">
      <button class="music-control-btn" id="playPauseBtn" onclick="togglePlayPause()" disabled>â–¶ æ’­æ”¾</button>
    </div>
    
    <div class="volume-slider-container">
      <span class="volume-icon">ğŸ”Š</span>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="30" oninput="changeVolume(this.value)">
      <span class="volume-value" id="volumeValue">30%</span>
    </div>
  </div>
</div>

<audio id="bgAudio" loop></audio>

<script>
/* 1. å…¨å±€é…ç½®ä¸æ•°æ® */
const IRIS_NOTES = [
  { t: '"I wanna be defined by the things that I love. Not the things I\'m afraid of."', a: "Taylor Swift Â· Daylight" },
  { t: '"I\'m still a believer, but I don\'t know why. I\'ve never been a natural, all I do is try, try, try."', a: "Taylor Swift Â· Mirrorball" },
  { t: '"I\'d like to be my old self again, but I\'m still trying to find it."', a: "Taylor Swift Â· All Too Well" },
  { t: '"This is me trying."', a: "Taylor Swift Â· this is me trying" },
  { t: '"I\'m doing good, I\'m on some new shit. Been saying \'yes\' instead of \'no\'."', a: "Taylor Swift Â· the 1" },
  { t: '"You drew stars around my scars, but now I\'m bleeding."', a: "Taylor Swift Â· Cardigan" },
  { t: '"Long live all the mountains we moved, I had the time of my life fighting dragons with you."', a: "Taylor Swift Â· Long Live" },
  { t: '"She lost him, but she found herself, and somehow that was everything."', a: "Taylor Swift Â· Out of the Woods" },
  { t: '"It\'s a new soundtrack I could dance to this beat. The lights are so bright But they never blind me."', a: "Taylor Swift Â· Welcome to New York" },
  { t: '"The best people in life are free."', a: "Taylor Swift Â· New Romantics" },
  { t: '"Honey life is just a classroom. Cause baby I could build a castle out of all the bricks they threw at me."', a: "Taylor Swift Â· Out of the Woods" },
  { t: '"The rest of the world was black and white. But we were in screaming color."', a: "Taylor Swift Â· Starlight" },
  { t: '"But the monsters turned out to be just trees."', a: "Taylor Swift Â· Out of the Woods" },
  { t: '"You\'ll spend your whole life singing the blues if you keep thinking that way."', a: "Taylor Swift Â· Shake It Off" }
];

const FOCUS_DB = [
  { name: "", txt: "ä¸“æ³¨åœ°çˆ±ä½ è‡ªå·±ã€‚" },
  { name: "Blaise", txt: "æ•ˆç‡æ˜¯å”¯ä¸€çš„ä¼˜é›…ã€‚åˆ«è®©æ‚å¿µæµªè´¹ä½ çš„æ—¶é—´ã€‚" },
  { name: "Sarah", txt: "æ…¢æ…¢æ¥ä¹Ÿå¯ä»¥ã€‚" },
  { name: "Noah", txt: "äº”åˆ†é’Ÿå°±è¡Œã€‚åˆ«è·Ÿè„‘å­åµæ¶ï¼Œå…ˆåŠ¨èµ·æ¥ï¼" }
];

const SHELF_DATA = {
  fanfics: [
    { title: "å¯†è¯­", meta: "2025 ç”Ÿè´º Â· C&B", url: "fanfic/å¯†è¯­.pdf" },
    { title: "åŒ—å›½ä¹‹æ—…", meta: "Christmas Special", url: "fanfic/åŒ—å›½ä¹‹æ—….pdf" }
  ],
  skits: [
    { date: "05-20", title: "520 ç‰¹è¾‘", url: "skits/520.html" }
  ]
};

/* 2. è®¡æ—¶å™¨æ·±åº¦è”åŠ¨æ ¸å¿ƒ */
let timer = null, isRest = false, timeLeft = 25 * 60, tomatoes = 0;
const fMin = document.getElementById('fMin'), bMin = document.getElementById('bMin'), 
      timeLabel = document.getElementById('timeLabel'), progress = document.getElementById('progress'),
      ring = document.getElementById('timerRing');

function updateUI() {
  const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
  timeLabel.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  const total = (isRest ? bMin.value : fMin.value) * 60;
  progress.style.strokeDashoffset = 283 * (1 - timeLeft / total);
}

// è”åŠ¨ï¼šä¿®æ”¹è¾“å…¥æ¡†å³æ—¶æ”¹å˜è®¡æ—¶æ˜¾ç¤º
fMin.oninput = bMin.oninput = () => {
  if(!timer) {
    timeLeft = (isRest?bMin.value:fMin.value)*60;
    updateUI();
    showRandomQuote();
  }
};

function showToast(msg, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

function showRandomQuote() {
  const q = FOCUS_DB[Math.floor(Math.random() * FOCUS_DB.length)];
  document.getElementById('focusQuote').textContent = q.name ? `ã€Œ${q.txt}ã€ â€”â€” ${q.name}` : `ã€Œ${q.txt}ã€`;
}

document.getElementById('toggleBtn').onclick = function() {
  if (timer) {
    clearInterval(timer); timer = null; this.textContent = "ç»§ç»­ä¸“æ³¨";
    ring.classList.remove('breathing');
  } else {
    ring.classList.add('breathing');
    showRandomQuote();
    timer = setInterval(() => {
      timeLeft--; updateUI();
      if (timeLeft <= 0) {
        clearInterval(timer); timer = null;
        isRest = !isRest;
        if(!isRest) { 
          tomatoes++; 
          document.getElementById('tCount').textContent = tomatoes;
          saveTomatoCount();
        }
        timeLeft = (isRest ? bMin.value : fMin.value) * 60;
        showToast(isRest ? "è¿™æ®µè¾›è‹¦äº†ï¼Œå–æ¯çº¢èŒ¶ä¼‘æ¯ä¸€ä¸‹å§ã€‚" : "ä¼‘æ¯ç»“æŸï¼Œæˆ‘ä»¬å¼€å§‹ä¸‹ä¸€æ®µã€‚", 4000);
        updateUI(); this.textContent = "å¼€å§‹ä¸“æ³¨";
        ring.classList.remove('breathing');
        showRandomQuote();
      }
    }, 1000);
    this.textContent = "æš‚åœ";
  }
};

/* 3. ä¹¦æ¶ä¸å¼¹çª—é€»è¾‘ */
function openShelf() { document.getElementById('modalOverlay').style.display='flex'; renderRoot(); }
function closeModal() { document.getElementById('modalOverlay').style.display='none'; }

function renderRoot() {
  document.getElementById('backBtn').style.visibility = 'hidden';
  document.getElementById('modalTitle').textContent = "ä¹¦æ¶ç›®å½•";
  document.getElementById('modalContent').innerHTML = `
    <div class="item-row" onclick="renderList('fanfics')">ğŸ“– åŒäººæ–‡ç³»åˆ— (Fanfics)</div>
    <div class="item-row" onclick="renderList('skits')">ğŸ­ å°å‰§åœºæ¡£æ¡ˆ (Skits)</div>
  `;
}

function renderList(cat) {
  document.getElementById('backBtn').style.visibility = 'visible';
  document.getElementById('modalTitle').textContent = cat==='fanfics'?'åŒäººæ–‡åˆ—è¡¨':'å°å‰§åœºåˆ—è¡¨';
  const items = SHELF_DATA[cat];
  document.getElementById('modalContent').innerHTML = items.map(it => `
    <div class="item-row" onclick="openItem('${it.url}', '${it.title}', '${cat}')">
      <div style="font-weight:700;">${it.title}</div>
      <div style="font-size:12px; color:var(--text-sub);">${it.meta || it.date}</div>
    </div>`).join('');
}

function openItem(url, title, cat) {
  if (cat === 'fanfics' && url.endsWith('.pdf')) {
    window.open(url, '_blank');
  } else {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalContent').innerHTML = `<iframe src="${url}"></iframe>`;
  }
}

/* 4. å¿ƒæƒ…æ—¥å†ç³»ç»Ÿ */
const MOODS = ['ğŸŒ¤ï¸ å¹³é™', 'âœ¨ é—ªè€€', 'ğŸŒ§ï¸ ä½è½', 'ğŸŒ¿ æ²»æ„ˆ', 'ğŸ”¥ åŠ¨åŠ›'];

function getMoodKey(date) {
  const d = date || new Date();
  return `mood_${d.getFullYear()}_${d.getMonth()+1}_${d.getDate()}`;
}

function getMoodsForDate(date) {
  const key = getMoodKey(date);
  const data = localStorage.getItem(key);
  return data ? JSON.parse(data) : [];
}

function saveMoodForDate(date, moodText, toggle = false) {
  const key = getMoodKey(date);
  const existing = getMoodsForDate(date);
  
  if (toggle) {
    // åˆ‡æ¢æ¨¡å¼ï¼šå¦‚æœå·²å­˜åœ¨åˆ™åˆ é™¤ï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ 
    const existingIndex = existing.findIndex(item => item.mood === moodText);
    if (existingIndex > -1) {
      // å·²å­˜åœ¨ï¼Œåˆ é™¤
      existing.splice(existingIndex, 1);
    } else {
      // ä¸å­˜åœ¨ï¼Œæ·»åŠ 
      existing.push({
        mood: moodText,
        time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      });
    }
  } else {
    // ä¼ ç»Ÿæ¨¡å¼ï¼šæ·»åŠ æ–°è®°å½•
    existing.push({
      mood: moodText,
      time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    });
  }
  
  localStorage.setItem(key, JSON.stringify(existing));
}

function getTomatoKey() {
  const d = new Date();
  return `tomato_${d.getFullYear()}_${d.getMonth()+1}_${d.getDate()}`;
}

function loadTomatoCount() {
  const count = localStorage.getItem(getTomatoKey());
  if (count) {
    tomatoes = parseInt(count);
    document.getElementById('tCount').textContent = tomatoes;
  }
}

function saveTomatoCount() {
  localStorage.setItem(getTomatoKey(), tomatoes.toString());
}

function renderMoods() {
  const today = new Date();
  const existingMoods = getMoodsForDate(today);
  const existingMoodTexts = existingMoods.map(item => item.mood);
  
  document.getElementById('moodList').innerHTML = MOODS.map(m => {
    const isSelected = existingMoodTexts.includes(m);
    return `
      <div style="padding:10px 15px; border-radius:15px; border:1px solid var(--iris-soft); cursor:pointer; font-size:14px; transition:all 0.2s; ${isSelected ? 'background:var(--iris-blue); color:white;' : 'background:transparent;'}" onclick="selectMood(this, '${m}')">${m}</div>
    `;
  }).join('');
  updateTodayMoodDisplay();
}

function selectMood(el, moodText) {
  const today = new Date();
  const existingMoods = getMoodsForDate(today);
  const isSelected = existingMoods.some(item => item.mood === moodText);
  
  // åˆ‡æ¢æ¨¡å¼ä¿å­˜
  saveMoodForDate(today, moodText, true);
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  if (isSelected) {
    // å·²é€‰ä¸­ï¼Œå–æ¶ˆé€‰ä¸­
    el.style.background = 'transparent';
    el.style.color = '';
    showToast(`å·²å–æ¶ˆä»Šæ—¥å¿ƒæƒ…ï¼š${moodText}`);
  } else {
    // æœªé€‰ä¸­ï¼Œè®¾ä¸ºé€‰ä¸­
    el.style.background = 'var(--iris-blue)';
    el.style.color = 'white';
    showToast(`å·²è®°å½•ä»Šæ—¥å¿ƒæƒ…ï¼š${moodText}`);
  }
  
  updateTodayMoodDisplay();
}

function updateTodayMoodDisplay() {
  const moods = getMoodsForDate(new Date());
  const countEl = document.getElementById('moodCountDisplay');
  const historyEl = document.getElementById('todayMoodHistory');
  
  if (moods.length > 0) {
    countEl.innerHTML = `ä»Šæ—¥å·²è®°å½• <span>${moods.length}</span> ç§å¿ƒæƒ…`;
    historyEl.innerHTML = moods.map(m => `
      <div class="mood-history-item">
        <span>${m.mood}</span>
        <span class="time">${m.time}</span>
      </div>
    `).join('');
  } else {
    countEl.innerHTML = 'ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•å¿ƒæƒ…å“¦ï½';
    historyEl.innerHTML = '';
  }
}

function openCalendar() {
  document.getElementById('modalOverlay').style.display='flex';
  document.getElementById('modalTitle').textContent = "å¿ƒæƒ…æ—¥å†";
  document.getElementById('backBtn').style.visibility = 'hidden';
  
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  let html = `<div style="padding:25px;">`;
  
  html += `<div style="text-align:center; margin-bottom:20px; font-size:18px; font-weight:600;">${year}å¹´${month+1}æœˆ</div>`;
  
  html += `<div class="cal-grid" style="margin-bottom:10px;">`;
  weekDays.forEach(d => {
    html += `<div style="text-align:center; font-size:12px; color:var(--text-sub); padding:5px;">${d}</div>`;
  });
  html += `</div>`;
  
  html += `<div class="cal-grid">`;
  
  for (let i = 0; i < firstDay; i++) {
    html += `<div class="cal-cell" style="opacity:0.3;"></div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const moods = getMoodsForDate(date);
    const isToday = day === today;
    
    let moodIcons = '';
    if (moods.length > 0) {
      const uniqueMoods = [...new Set(moods.map(m => m.mood.split(' ')[0]))];
      moodIcons = `<div class="mood-icons">${uniqueMoods.slice(0, 3).join('')}${moods.length > 3 ? 'â€¦' : ''}</div>`;
    }
    
    html += `
      <div class="cal-cell ${isToday ? 'today' : ''}" onclick="showDayMoods(${year}, ${month}, ${day})">
        <b>${day}</b>
        ${moodIcons}
        ${moods.length > 0 ? `<div style="font-size:9px; color:var(--iris-blue);">${moods.length}ç§</div>` : ''}
      </div>
    `;
  }
  
  html += `</div></div>`;
  document.getElementById('modalContent').innerHTML = html;
}

function showDayMoods(year, month, day) {
  const date = new Date(year, month, day);
  const moods = getMoodsForDate(date);
  const today = new Date();
  const isToday = date.toDateString() === today.toDateString();
  
  document.getElementById('modalTitle').textContent = `${month+1}æœˆ${day}æ—¥å¿ƒæƒ…`;
  document.getElementById('backBtn').style.visibility = 'visible';
  document.getElementById('backBtn').onclick = openCalendar;
  
  let html = `<div style="padding:25px;">`;
  
  if (moods.length === 0) {
    html += `<div style="text-align:center; color:var(--text-sub); padding:40px;">è¿™ä¸€å¤©è¿˜æ²¡æœ‰è®°å½•å¿ƒæƒ…</div>`;
  } else {
    html += `<div style="display:flex; flex-direction:column; gap:12px;">`;
    moods.forEach((m, i) => {
      html += `
        <div class="mood-history-item" style="font-size:16px; padding:15px;">
          <span style="font-size:24px;">${m.mood.split(' ')[0]}</span>
          <span style="flex:1;">${m.mood.split(' ')[1]}</span>
          <span class="time">${m.time}</span>
        </div>
      `;
    });
    html += `</div>`;
  }
  
  if (isToday) {
    html += `
      <div style="margin-top:30px; padding-top:20px; border-top:1px solid var(--border-line);">
        <h4 style="margin:0 0 15px 0; color:var(--iris-medium);">æ·»åŠ ä»Šæ—¥å¿ƒæƒ…</h4>
        <div style="display:flex; flex-wrap:wrap; gap:10px;">
          ${MOODS.map(m => `
            <div style="padding:10px 15px; border-radius:15px; border:1px solid var(--iris-soft); cursor:pointer; font-size:14px; transition:all 0.2s; background:transparent;" onclick="addMoodFromCalendar('${m}')">${m}</div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  document.getElementById('modalContent').innerHTML = html;
}

function addMoodFromCalendar(moodText) {
  const today = new Date();
  saveMoodForDate(today, moodText);
  showToast(`å·²è®°å½•å¿ƒæƒ…ï¼š${moodText}`);
  updateTodayMoodDisplay();
  showDayMoods(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
}

// åˆå§‹åŒ–ä¾¿ç­¾
const dayIdx = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
const note = IRIS_NOTES[dayIdx % IRIS_NOTES.length];
document.getElementById('noteTxt').textContent = note.t;
document.getElementById('noteAuth').textContent = `â€”â€” ${note.a}`;

// åŠ è½½ç•ªèŒ„é’Ÿè®¡æ•°
loadTomatoCount();

renderMoods();
updateUI();

/* 5. éŸ³ä¹ç®¡ç†ç³»ç»Ÿ */
let musicList = [];
let currentMusicIndex = -1;
let isPlaying = false;
const bgAudio = document.getElementById('bgAudio');

const DEFAULT_MUSIC_LIST = [
  { id: 'mystery-of-love', name: 'Mystery of Love / Visions of Gideon', url: 'https://music.163.com/song/media/outer/url?id=1442339347.mp3', isDefault: false },
  { id: 'moonlight', name: 'æœˆå…‰', url: 'https://music.163.com/song/media/outer/url?id=1806854425.mp3', isDefault: false },
  { id: 'fireplace', name: 'å£ç‚‰', url: 'https://music.163.com/song/media/outer/url?id=532444923.mp3', isDefault: false },
  { id: 'rain', name: 'å¬é›¨', url: 'https://music.163.com/song/media/outer/url?id=853708.mp3', isDefault: false }
];

function initMusicManager() {
  musicList = DEFAULT_MUSIC_LIST.map(m => ({ ...m }));
  bgAudio.volume = 0.3;
  updateMusicList();
}

function toggleMusicPanel() {
  const panel = document.getElementById('music-panel');
  panel.classList.toggle('active');
}

function handleMusicUpload(event) {
  const files = event.target.files;
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (file.type.startsWith('audio/')) {
      const musicData = {
        id: Date.now() + i,
        name: file.name.replace(/\.[^/.]+$/, ''),
        file: file,
        url: URL.createObjectURL(file),
        isDefault: false
      };
      musicList.push(musicData);
    }
  }
  
  updateMusicList();
  event.target.value = '';
  showToast('éŸ³ä¹å·²æ·»åŠ åˆ°åˆ—è¡¨');
}

function updateMusicList() {
  const listContainer = document.getElementById('music-list');
  
  if (musicList.length === 0) {
    listContainer.innerHTML = '<div class="no-music">æš‚æ— éŸ³ä¹</div>';
    document.getElementById('playPauseBtn').disabled = true;
    return;
  }
  
  document.getElementById('playPauseBtn').disabled = false;
  listContainer.innerHTML = '';
  
  musicList.forEach((music, index) => {
    const item = document.createElement('div');
    item.className = 'music-item' + (index === currentMusicIndex ? ' active' : '');
    
    const deleteBtn = music.isDefault 
      ? '' 
      : `<button class="music-item-delete" onclick="deleteMusic(${index}, event)" title="åˆ é™¤">âœ•</button>`;
    
    item.innerHTML = `
      <div class="music-item-info" onclick="selectMusic(${index})">
        <span class="music-item-icon">ğŸµ</span>
        <span class="music-item-name">${music.name}</span>
      </div>
      ${deleteBtn}
    `;
    listContainer.appendChild(item);
  });
}

function selectMusic(index) {
  if (currentMusicIndex === index && isPlaying) {
    return;
  }
  
  currentMusicIndex = index;
  const music = musicList[index];
  
  bgAudio.src = music.url;
  bgAudio.load();
  
  if (isPlaying) {
    playMusic();
  }
  
  updateMusicList();
  showToast(`å·²é€‰æ‹©ï¼š${music.name}`);
}

function togglePlayPause() {
  if (isPlaying) {
    pauseMusic();
  } else {
    playMusic();
  }
}

function playMusic() {
  if (musicList.length === 0) return;
  
  if (currentMusicIndex === -1) {
    selectMusic(0);
  }
  
  bgAudio.play().then(() => {
    isPlaying = true;
    updatePlayButton();
    document.getElementById('musicToggleBtn').classList.add('playing');
  }).catch(e => {
    console.log('æ’­æ”¾å¤±è´¥:', e);
    showToast('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–éŸ³ä¹');
  });
}

function pauseMusic() {
  bgAudio.pause();
  isPlaying = false;
  updatePlayButton();
  document.getElementById('musicToggleBtn').classList.remove('playing');
}

function updatePlayButton() {
  const btn = document.getElementById('playPauseBtn');
  btn.textContent = isPlaying ? 'â¸ æš‚åœ' : 'â–¶ æ’­æ”¾';
  btn.classList.toggle('playing', isPlaying);
}

function changeVolume(value) {
  bgAudio.volume = value / 100;
  document.getElementById('volumeValue').textContent = value + '%';
  const icon = document.querySelector('.volume-icon');
  if (value == 0) {
    icon.textContent = 'ğŸ”‡';
  } else if (value < 30) {
    icon.textContent = 'ğŸ”ˆ';
  } else if (value < 70) {
    icon.textContent = 'ğŸ”‰';
  } else {
    icon.textContent = 'ğŸ”Š';
  }
}

function deleteMusic(index, event) {
  event.stopPropagation();
  
  const music = musicList[index];
  if (music.isDefault) return;
  
  if (currentMusicIndex === index) {
    pauseMusic();
    currentMusicIndex = -1;
  } else if (currentMusicIndex > index) {
    currentMusicIndex--;
  }
  
  if (!music.isDefault && music.url.startsWith('blob:')) {
    URL.revokeObjectURL(music.url);
  }
  
  musicList.splice(index, 1);
  updateMusicList();
  showToast('éŸ³ä¹å·²åˆ é™¤');
}

bgAudio.addEventListener('ended', () => {
  if (musicList.length > 1 && currentMusicIndex < musicList.length - 1) {
    selectMusic(currentMusicIndex + 1);
    playMusic();
  } else if (musicList.length > 0) {
    bgAudio.currentTime = 0;
    bgAudio.play();
  }
});

bgAudio.addEventListener('error', () => {
  showToast('éŸ³ä¹åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯é“¾æ¥ä¸å¯ç”¨');
});

initMusicManager();
</script>
</body>
</html>
